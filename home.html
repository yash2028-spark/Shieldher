<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Incident | ShieldHer</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="pb-20">
    <nav class="border-b border-zinc-900 p-4 sticky top-0 bg-black/80 backdrop-blur-md z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-rose-600">ShieldHer</h1>
            <div class="flex gap-6 items-center">
                <a href="/dashboard.html" class="nav-link">Dashboard</a>
                <a href="/home.html" class="nav-link active">Report</a>
                <a href="/vault.html" class="nav-link">Vault</a>
                <button id="btnLogout" class="text-xs text-zinc-500 hover:text-white uppercase tracking-widest font-bold">Logout</button>
            </div>
        </div>
    </nav>

    <main class="max-w-2xl mx-auto p-4 mt-10">
        <div class="glass-card p-8 shadow-xl">
            <h2 class="text-2xl font-bold mb-6">Report Incident</h2>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-2">Description</label>
                    <textarea id="description" class="input-field min-h-[150px]" placeholder="Provide a detailed description of the incident..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-2">Location</label>
                        <input type="text" id="location" class="input-field" placeholder="Enter incident location">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-2">Date & Time</label>
                        <input type="datetime-local" id="datetime" class="input-field">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-2">Evidence Attachment</label>
                    <div class="border-2 border-dashed border-zinc-800 rounded-xl p-10 text-center hover:border-rose-500/50 transition-all cursor-pointer group relative overflow-hidden" id="dropZone">
                        <input type="file" id="fileInput" class="hidden" multiple>
                        <div id="fileStatus">
                            <p class="text-zinc-400 group-hover:text-zinc-300">Click to upload photos, videos, or audio</p>
                            <p class="text-[10px] text-zinc-600 mt-2 uppercase tracking-widest">Files are encrypted client-side</p>
                        </div>
                        <!-- Progress Bar Container -->
                        <div id="progressContainer" class="absolute bottom-0 left-0 w-full h-1 bg-zinc-900 hidden">
                            <div id="progressBar" class="h-full bg-rose-600 transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <button id="btnSubmit" class="btn-primary w-full py-4 text-lg shadow-lg shadow-rose-900/20">
                    Encrypt & Save to Vault
                </button>
            </div>
        </div>
    </main>

    <!-- Master Passphrase Modal -->
    <div id="vaultModal" class="modal-overlay">
        <div class="modal-content glass-card p-8 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-2" id="modalTitle">Unlock Vault</h3>
            <p class="text-zinc-500 text-xs mb-6" id="modalDesc">Enter your master passphrase to enable encryption.</p>
            
            <div id="setupFields" class="hidden space-y-4 mb-4">
                <input type="password" id="passphrase1" class="input-field" placeholder="Create Passphrase">
                <input type="password" id="passphrase2" class="input-field" placeholder="Confirm Passphrase">
            </div>
            
            <div id="unlockFields" class="mb-4">
                <input type="password" id="passphraseUnlock" class="input-field" placeholder="Master Passphrase">
            </div>

            <button id="btnVaultAction" class="btn-primary w-full">Unlock</button>
            <p class="text-[10px] text-zinc-600 mt-4 text-center italic">Your passphrase is never stored on our servers.</p>
        </div>
    </div>

    <script type="module">
        console.log('ShieldHer Home Script Loading...');
        import { auth, checkAuth } from './js/auth.js';
        import { hashPassphrase } from './js/crypto.js';
        import { submitIncident } from './js/incident.js';

        const vaultModal = document.getElementById('vaultModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalDesc = document.getElementById('modalDesc');
        const setupFields = document.getElementById('setupFields');
        const unlockFields = document.getElementById('unlockFields');
        const btnVaultAction = document.getElementById('btnVaultAction');
        
        const passphrase1 = document.getElementById('passphrase1');
        const passphrase2 = document.getElementById('passphrase2');
        const passphraseUnlock = document.getElementById('passphraseUnlock');

        const descriptionInput = document.getElementById('description');
        const locationInput = document.getElementById('location');
        const datetimeInput = document.getElementById('datetime');
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const fileStatus = document.getElementById('fileStatus');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const btnSubmit = document.getElementById('btnSubmit');
        const btnLogout = document.getElementById('btnLogout');

        let currentUserId = null;

        async function init() {
            try {
                const session = await checkAuth();
                if (!session) return;

                currentUserId = session.user.id;
                // Set default date
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                datetimeInput.value = now.toISOString().slice(0, 16);

                // Check if vault is unlocked in session
                if (!sessionStorage.getItem('vault_key')) {
                    showVaultModal(currentUserId);
                }
            } catch (error) {
                console.error('Init error:', error);
            }
        }

        function showVaultModal(userId) {
            console.log('Showing vault modal for user:', userId);
            vaultModal.classList.add('active');
            const hasVault = localStorage.getItem(`vault_hash_${userId}`);
            
            if (!hasVault) {
                modalTitle.textContent = 'Setup Vault';
                modalDesc.textContent = 'Create a master passphrase. This is essential for encryption and cannot be recovered if lost.';
                setupFields.classList.remove('hidden');
                unlockFields.classList.add('hidden');
                btnVaultAction.textContent = 'Create Vault';
            } else {
                modalTitle.textContent = 'Unlock Vault';
                modalDesc.textContent = 'Enter your master passphrase to access your secure data.';
                setupFields.classList.add('hidden');
                unlockFields.classList.remove('hidden');
                btnVaultAction.textContent = 'Unlock';
            }
        }

        btnVaultAction.onclick = async () => {
            try {
                if (!currentUserId) {
                    const session = await auth.getSession();
                    if (!session) throw new Error('Session not found. Please log in again.');
                    currentUserId = session.user.id;
                }

                const hasVault = localStorage.getItem(`vault_hash_${currentUserId}`);
                console.log('Vault action triggered. Has vault:', !!hasVault);
                
                if (!hasVault) {
                    const p1 = passphrase1.value;
                    const p2 = passphrase2.value;
                    
                    console.log('Attempting vault creation. P1 length:', p1.length, 'P2 length:', p2.length);
                    
                    if (!p1 || !p2) return alert('Please fill in both passphrase fields');
                    if (p1.length < 8) return alert('Passphrase must be at least 8 characters');
                    if (p1 !== p2) return alert('Passphrases do not match');
                    
                    btnVaultAction.disabled = true;
                    btnVaultAction.textContent = 'Creating...';
                    
                    const hash = await hashPassphrase(p1);
                    localStorage.setItem(`vault_hash_${currentUserId}`, hash);
                    sessionStorage.setItem('vault_key', p1);
                    
                    console.log('Vault created successfully');
                    vaultModal.classList.remove('active');
                } else {
                    const p = passphraseUnlock.value;
                    if (!p) return alert('Please enter your passphrase');
                    
                    const hash = await hashPassphrase(p);
                    if (hash === localStorage.getItem(`vault_hash_${currentUserId}`)) {
                        sessionStorage.setItem('vault_key', p);
                        console.log('Vault unlocked successfully');
                        vaultModal.classList.remove('active');
                    } else {
                        alert('Incorrect passphrase');
                    }
                }
            } catch (error) {
                console.error('Vault action error:', error);
                alert('Error: ' + error.message);
            } finally {
                const hasVault = localStorage.getItem(`vault_hash_${currentUserId}`);
                btnVaultAction.disabled = false;
                btnVaultAction.textContent = hasVault ? 'Unlock' : 'Create Vault';
            }
        };

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = () => {
            if (fileInput.files.length > 0) {
                const count = fileInput.files.length;
                fileStatus.innerHTML = `<p class="text-rose-500 font-bold">${count} file(s) selected</p><p class="text-[10px] text-zinc-600">Encrypted upload ready</p>`;
            }
        };

        btnSubmit.onclick = async () => {
            const description = descriptionInput.value;
            const location = locationInput.value;
            const dateValue = datetimeInput.value;
            const files = Array.from(fileInput.files);

            if (!description) return alert('Please enter a description');
            if (!sessionStorage.getItem('vault_key')) {
                const session = await auth.getSession();
                return showVaultModal(session.user.id);
            }

            btnSubmit.disabled = true;
            btnSubmit.textContent = 'Processing...';
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';

            try {
                await submitIncident({ 
                    description, 
                    location, 
                    dateValue, 
                    files,
                    onProgress: (p) => {
                        progressBar.style.width = `${p}%`;
                        if (p < 100) {
                            btnSubmit.textContent = `Securing... ${p}%`;
                        } else {
                            btnSubmit.textContent = 'Finalizing...';
                        }
                    }
                });
                alert('Incident reported and secured!');
                window.location.href = '/vault.html';
            } catch (error) {
                alert('Error: ' + error.message);
                progressContainer.classList.add('hidden');
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'Encrypt & Save to Vault';
            }
        };

        btnLogout.onclick = () => auth.signOut();

        init();
    </script>
</body>
</html>
