<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vault | ShieldHer</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Libraries for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="pb-20">
    <!-- Navigation -->
    <nav class="border-b border-zinc-800 p-4 sticky top-0 bg-black/50 backdrop-blur-md z-40">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-rose-600">ShieldHer</h1>
            <div class="flex gap-6 items-center">
                <a href="/Home.html" class="nav-link">Report</a>
                <a href="/History.html" class="nav-link active">Vault</a>
                <button id="btnLogout" class="text-sm text-zinc-500 hover:text-white">Logout</button>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-4 mt-8">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold">Your Secure Vault</h2>
                <p class="text-zinc-500">Zero-knowledge storage of your evidence</p>
            </div>
            <div class="flex gap-3">
                <button id="btnExportPDF" class="btn-secondary text-sm">PDF Report</button>
                <button id="btnExportZIP" class="btn-secondary text-sm">Export All (ZIP)</button>
            </div>
        </div>

        <div id="loadingState" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-rose-600 mb-4"></div>
            <p class="text-zinc-500">Decrypting your vault...</p>
        </div>

        <div id="emptyState" class="hidden text-center py-20 glass-card">
            <p class="text-zinc-500 mb-4">No incidents found in your vault.</p>
            <a href="/Home.html" class="btn-primary">Report New Incident</a>
        </div>

        <div id="incidentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cards will be injected here -->
        </div>
    </main>

    <!-- Vault Unlock Modal -->
    <div id="unlockModal" class="modal-overlay">
        <div class="modal-content glass-card p-8">
            <h3 class="text-xl font-bold mb-2">Unlock Your Vault</h3>
            <p class="text-zinc-400 text-sm mb-6">Enter your master passphrase to decrypt your data.</p>
            <input type="password" id="vaultPassphrase" class="input-field mb-4" placeholder="Your master passphrase">
            <button id="btnUnlock" class="btn-primary w-full">Unlock Vault</button>
        </div>
    </div>

    <script type="module">
        import { auth, checkAuth } from './js/auth.js';
        import { fetchIncidents, decryptIncident, downloadEvidence, exportToPDF, exportToZIP } from './js/history.js';

        const incidentGrid = document.getElementById('incidentGrid');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const unlockModal = document.getElementById('unlockModal');
        const vaultPassphraseInput = document.getElementById('vaultPassphrase');
        const btnUnlock = document.getElementById('btnUnlock');
        const btnExportPDF = document.getElementById('btnExportPDF');
        const btnExportZIP = document.getElementById('btnExportZIP');
        const btnLogout = document.getElementById('btnLogout');

        let decryptedIncidents = [];

        async function init() {
            const session = await checkAuth();
            if (!session) return;

            if (!auth.isVaultUnlocked()) {
                unlockModal.classList.add('active');
            } else {
                loadVault();
            }
        }

        btnUnlock.onclick = () => {
            const pass = vaultPassphraseInput.value;
            if (pass.length < 8) return alert('Passphrase must be at least 8 characters');
            auth.setPassphrase(pass);
            unlockModal.classList.remove('active');
            loadVault();
        };

        async function loadVault() {
            loadingState.classList.remove('hidden');
            incidentGrid.innerHTML = '';
            
            try {
                const session = await auth.getSession();
                const rawIncidents = await fetchIncidents();
                const passphrase = auth.getPassphrase();
                const userId = session.user.id;

                if (rawIncidents.length === 0) {
                    emptyState.classList.remove('hidden');
                    loadingState.classList.add('hidden');
                    return;
                }

                decryptedIncidents = await Promise.all(
                    rawIncidents.map(inc => decryptIncident(inc, passphrase, userId))
                );

                renderIncidents();
            } catch (error) {
                alert('Error loading vault: ' + error.message);
            } finally {
                loadingState.classList.add('hidden');
            }
        }

        function renderIncidents() {
            incidentGrid.innerHTML = '';
            decryptedIncidents.forEach(inc => {
                const card = document.createElement('div');
                card.className = 'incident-card glass-card p-6 flex flex-col';
                
                if (inc.decryptionError) {
                    card.innerHTML = `
                        <div class="text-rose-500 mb-4">‚ö†Ô∏è Decryption Failed</div>
                        <p class="text-xs text-zinc-500">This incident was encrypted with a different passphrase or the data is corrupted.</p>
                    `;
                } else {
                    const date = new Date(inc.decrypted.date).toLocaleString();
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold">Incident</span>
                            <span class="text-[10px] text-zinc-600">${new Date(inc.created_at).toLocaleDateString()}</span>
                        </div>
                        <h3 class="font-bold text-lg mb-1">${date}</h3>
                        <p class="text-xs text-rose-500 mb-4 flex items-center gap-1">
                            üìç ${inc.decrypted.location.lat.toFixed(4)}, ${inc.decrypted.location.lng.toFixed(4)}
                        </p>
                        <p class="text-sm text-zinc-400 line-clamp-3 mb-6 flex-grow">${inc.decrypted.description}</p>
                        
                        <div class="pt-4 border-t border-zinc-800 flex gap-2">
                            ${inc.file_path ? `
                                <button class="btn-download btn-primary text-xs py-2 px-3 flex-1" data-id="${inc.id}">
                                    Download Evidence
                                </button>
                            ` : '<span class="text-xs text-zinc-600 italic">No evidence attached</span>'}
                        </div>
                    `;

                    const downloadBtn = card.querySelector('.btn-download');
                    if (downloadBtn) {
                        downloadBtn.onclick = async () => {
                            downloadBtn.disabled = true;
                            downloadBtn.textContent = 'Verifying...';
                            try {
                                await downloadEvidence(inc);
                            } catch (e) {
                                alert(e.message);
                            } finally {
                                downloadBtn.disabled = false;
                                downloadBtn.textContent = 'Download Evidence';
                            }
                        };
                    }
                }
                incidentGrid.appendChild(card);
            });
        }

        btnExportPDF.onclick = () => exportToPDF(decryptedIncidents);
        btnExportZIP.onclick = () => exportToZIP(decryptedIncidents);
        btnLogout.onclick = () => auth.signOut();

        init();
    </script>
</body>
</html>
