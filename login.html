<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - ShieldHer</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="auth-card animate-fade">
            <h1 id="authTitle">Login</h1>
            <p id="authSubtitle">Access your secure vault</p>

            <form id="authForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" required placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">Sign In</button>
            </form>

            <button class="btn btn-google" id="googleBtn">
                <img src="https://img.icons8.com/color/24/google-logo.png" alt="Google" referrerPolicy="no-referrer">
                Continue with Google
            </button>

            <div class="auth-footer">
                <span id="toggleText">Don't have an account?</span>
                <a href="#" id="toggleAuth">Sign Up</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { signIn, signUp, signInWithGoogle } from './js/auth.js';
        import { deriveKey } from './js/crypto.js';

        const authForm = document.getElementById('authForm');
        const toggleAuth = document.getElementById('toggleAuth');
        const authTitle = document.getElementById('authTitle');
        const authSubtitle = document.getElementById('authSubtitle');
        const submitBtn = document.getElementById('submitBtn');
        const toggleText = document.getElementById('toggleText');
        const googleBtn = document.getElementById('googleBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');

        let isLogin = true;

        toggleAuth.addEventListener('click', (e) => {
            e.preventDefault();
            isLogin = !isLogin;
            authTitle.innerText = isLogin ? 'Login' : 'Sign Up';
            authSubtitle.innerText = isLogin ? 'Access your secure vault' : 'Create your secure vault';
            submitBtn.innerText = isLogin ? 'Sign In' : 'Create Account';
            toggleText.innerText = isLogin ? "Don't have an account?" : "Already have an account?";
            toggleAuth.innerText = isLogin ? 'Sign Up' : 'Sign In';
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            loadingOverlay.style.display = 'flex';

            try {
                const { data, error } = isLogin 
                    ? await signIn(email, password) 
                    : await signUp(email, password);

                if (error) throw error;

                // On success, derive vault key and store in sessionStorage
                const userId = data.user.id;
                const vaultKey = await deriveKey(password, userId);
                
                // Export key to store it (sessionStorage only)
                const exportedKey = await crypto.subtle.exportKey("raw", vaultKey);
                sessionStorage.setItem('vault_key', btoa(String.fromCharCode(...new Uint8Array(exportedKey))));
                
                window.location.href = 'dashboard.html';
            } catch (err) {
                alert(err.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });

        googleBtn.addEventListener('click', async () => {
            await signInWithGoogle();
        });
    </script>
</body>
</html>
